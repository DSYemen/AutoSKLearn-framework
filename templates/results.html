{% extends "base.html" %} {% block title %}ML Framework - Results{% endblock %}
{% block content %}
<div class="space-y-6">
  <!-- شريط التقدم -->
  <div id="progressSection" class="bg-white shadow-lg rounded-lg p-6">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-semibold">حالة المعالجة</h3>
      <span
        id="progressPercentage"
        class="text-sm font-medium bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full"
        >0%</span
      >
    </div>
    <div class="relative pt-1">
      <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-indigo-100">
        <div
          id="progressBar"
          class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-indigo-600 transition-all duration-500"
          style="width: 0%"
        ></div>
      </div>
    </div>
    <p id="statusMessage" class="text-sm text-gray-600">
      جاري تحليل البيانات...
    </p>
  </div>

  <!-- ملخص النتائج -->
  <div id="summarySection" class="bg-white shadow-lg rounded-lg p-6 hidden">
    <div class="border-b pb-4 mb-4">
      <h2 class="text-xl font-bold">ملخص النتائج</h2>
      <p class="text-sm text-gray-600 mt-1">
        تم تحليل البيانات وتدريب النموذج بنجاح
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-gray-50 rounded-lg p-4">
        <span class="text-sm text-gray-500">دقة النموذج</span>
        <div class="flex items-end mt-1">
          <span id="modelAccuracy" class="text-2xl font-bold">-</span>
          <span class="text-sm text-gray-500 ml-1">%</span>
        </div>
      </div>
      <div class="bg-gray-50 rounded-lg p-4">
        <span class="text-sm text-gray-500">عدد المميزات</span>
        <div class="mt-1">
          <span id="featureCount" class="text-2xl font-bold">-</span>
        </div>
      </div>
      <div class="bg-gray-50 rounded-lg p-4">
        <span class="text-sm text-gray-500">وقت التدريب</span>
        <div class="mt-1">
          <span id="trainingTime" class="text-2xl font-bold">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- تفاصيل النموذج -->
  <div
    id="modelDetailsSection"
    class="bg-white shadow-lg rounded-lg p-6 hidden"
  >
    <div class="border-b pb-4 mb-4">
      <h2 class="text-xl font-bold">تفاصيل النموذج</h2>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- مخطط أداء النموذج -->
      <div class="bg-white rounded-lg border p-4">
        <h3 class="text-lg font-semibold mb-4">أداء النموذج</h3>
        <div id="modelPerformancePlot" class="h-64"></div>
      </div>

      <!-- مخطط أهمية المميزات -->
      <div class="bg-white rounded-lg border p-4">
        <h3 class="text-lg font-semibold mb-4">أهمية المميزات</h3>
        <div id="featureImportancePlot" class="h-64"></div>
      </div>
    </div>

    <!-- جدول المقاييس -->
    <div class="mt-6">
      <h3 class="text-lg font-semibold mb-4">مقاييس الأداء</h3>
      <div class="bg-gray-50 rounded-lg p-4">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <span class="text-sm text-gray-500">Precision</span>
            <p id="precisionMetric" class="text-lg font-semibold mt-1">-</p>
          </div>
          <div>
            <span class="text-sm text-gray-500">Recall</span>
            <p id="recallMetric" class="text-lg font-semibold mt-1">-</p>
          </div>
          <div>
            <span class="text-sm text-gray-500">F1 Score</span>
            <p id="f1Metric" class="text-lg font-semibold mt-1">-</p>
          </div>
          <div>
            <span class="text-sm text-gray-500">ROC AUC</span>
            <p id="rocAucMetric" class="text-lg font-semibold mt-1">-</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- أزرار الإجراءات -->
  <div id="actionButtons" class="flex justify-end space-x-4 hidden">
    <button
      onclick="downloadReport()"
      class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
    >
      تحميل التقرير
    </button>
    <button
      onclick="viewDashboard()"
      class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
    >
      عرض لوحة التحكم
    </button>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let modelData = null;
  let modelId = null;

  document.addEventListener("DOMContentLoaded", () => {
    // بدء عملية المعالجة
    startProcessing();
  });

  async function startProcessing() {
    try {
      const response = await fetch(`/api/v1/processing-status`);
      const data = await response.json();

      updateProgress(data.progress, data.status);

      if (data.progress < 100) {
        setTimeout(startProcessing, 1000);
      } else {
        await loadModelResults();
      }
    } catch (error) {
      console.error("Error:", error);
      showError("حدث خطأ أثناء المعالجة");
    }
  }

  function updateProgress(progress, status) {
    const progressBar = document.getElementById("progressBar");
    const progressPercentage = document.getElementById("progressPercentage");
    const statusMessage = document.getElementById("statusMessage");

    progressBar.style.width = `${progress}%`;
    progressPercentage.textContent = `${progress}%`;
    if (status) {
      statusMessage.textContent = status;
    }
  }

  async function loadModelResults() {
    try {
      const response = await fetch(`/api/v1/models/${modelId}/results`);
      modelData = await response.json();

      // إخفاء قسم التقدم وإظهار النتائج
      document.getElementById("progressSection").classList.add("hidden");
      document.getElementById("summarySection").classList.remove("hidden");
      document.getElementById("modelDetailsSection").classList.remove("hidden");
      document.getElementById("actionButtons").classList.remove("hidden");

      updateUI();
      createPlots();
    } catch (error) {
      console.error("Error:", error);
      showError("حدث خطأ أثناء تحميل النتائج");
    }
  }

  function updateUI() {
    // تحديث الملخص
    document.getElementById("modelAccuracy").textContent = (
      modelData.metrics.accuracy * 100
    ).toFixed(2);
    document.getElementById("featureCount").textContent =
      modelData.feature_count;
    document.getElementById(
      "trainingTime"
    ).textContent = `${modelData.training_time}s`;

    // تحديث المقاييس
    document.getElementById("precisionMetric").textContent =
      modelData.metrics.precision.toFixed(4);
    document.getElementById("recallMetric").textContent =
      modelData.metrics.recall.toFixed(4);
    document.getElementById("f1Metric").textContent =
      modelData.metrics.f1.toFixed(4);
    document.getElementById("rocAucMetric").textContent =
      modelData.metrics.roc_auc.toFixed(4);
  }

  function createPlots() {
    // مخطط أداء النموذج
    Plotly.newPlot(
      "modelPerformancePlot",
      [
        {
          x: modelData.learning_curve.train_sizes,
          y: modelData.learning_curve.train_scores,
          name: "Training Score",
          type: "scatter",
          mode: "lines+markers",
        },
        {
          x: modelData.learning_curve.train_sizes,
          y: modelData.learning_curve.test_scores,
          name: "Validation Score",
          type: "scatter",
          mode: "lines+markers",
        },
      ],
      {
        margin: { t: 20 },
        xaxis: { title: "Training Examples" },
        yaxis: { title: "Score" },
      }
    );

    // مخطط أهمية المميزات
    const featureImportance = modelData.feature_importance;
    const features = Object.keys(featureImportance);
    const importance = Object.values(featureImportance);

    Plotly.newPlot(
      "featureImportancePlot",
      [
        {
          y: features,
          x: importance,
          type: "bar",
          orientation: "h",
          marker: {
            color: "rgb(79, 70, 229)",
          },
        },
      ],
      {
        margin: { l: 150, t: 20 },
        xaxis: { title: "Importance" },
      }
    );
  }

  function showError(message) {
    const statusMessage = document.getElementById("statusMessage");
    statusMessage.textContent = message;
    statusMessage.classList.add("text-red-600");
  }

  function downloadReport() {
    window.location.href = `/api/v1/models/${modelId}/report/download`;
  }

  function viewDashboard() {
    window.location.href = `/dashboard/${modelId}`;
  }
</script>
{% endblock %}
