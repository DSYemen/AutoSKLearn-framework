{% extends "base.html" %}
{% block title %}ML Framework - ูุชุงุฆุฌ ุงูุชุฏุฑูุจ{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- ุดุฑูุท ุงูุญุงูุฉ -->
    <div class="bg-white shadow-lg rounded-lg p-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="bg-indigo-100 p-3 rounded-lg">
                    <i class="fas fa-chart-pie text-indigo-600 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">ูุชุงุฆุฌ ุงูุชุฏุฑูุจ</h1>
                    <p class="text-gray-600">ูุนุฑู ุงููููุฐุฌ: {{ model_id }}</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <span id="trainingStatus" class="px-3 py-1 rounded-full text-sm font-medium 
                    {% if model_data.status == 'completed' %}
                        bg-green-100 text-green-800
                    {% elif model_data.status == 'failed' %}
                        bg-red-100 text-red-800
                    {% else %}
                        bg-yellow-100 text-yellow-800
                    {% endif %}">
                    {{ model_data.status }}
                </span>
            </div>
        </div>
    </div>

    <!-- ุดุฑูุท ุงูุชูุฏู -->
    <div id="progressSection" class="bg-white shadow-lg rounded-lg p-6 {% if model_data.status == 'completed' %}hidden{% endif %}">
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold">ุชูุฏู ุงูุชุฏุฑูุจ</h2>
                <span id="progressPercentage" class="text-sm font-medium text-indigo-600">0%</span>
            </div>
            
            <div class="relative pt-1">
                <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-indigo-200">
                    <div id="progressBar" 
                         class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-indigo-600 transition-all duration-500"
                         style="width: 0%">
                    </div>
                </div>
            </div>

            <div id="processingSteps" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="processing-step" data-step="data-loading">
                    <div class="flex items-center space-x-2">
                        <span class="step-indicator">โช</span>
                        <span>ุชุญููู ุงูุจูุงูุงุช</span>
                    </div>
                </div>
                <div class="processing-step" data-step="preprocessing">
                    <div class="flex items-center space-x-2">
                        <span class="step-indicator">โช</span>
                        <span>ุงููุนุงูุฌุฉ ุงูุฃูููุฉ</span>
                    </div>
                </div>
                <div class="processing-step" data-step="feature-engineering">
                    <div class="flex items-center space-x-2">
                        <span class="step-indicator">โช</span>
                        <span>ููุฏุณุฉ ุงููููุฒุงุช</span>
                    </div>
                </div>
                <div class="processing-step" data-step="model-selection">
                    <div class="flex items-center space-x-2">
                        <span class="step-indicator">โช</span>
                        <span>ุงุฎุชูุงุฑ ุงููููุฐุฌ</span>
                    </div>
                </div>
                <div class="processing-step" data-step="training">
                    <div class="flex items-center space-x-2">
                        <span class="step-indicator">โช</span>
                        <span>ุชุฏุฑูุจ ุงููููุฐุฌ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ูุชุงุฆุฌ ุงูุชุฏุฑูุจ -->
    <div id="resultsSection" class="{% if model_data.status != 'completed' %}hidden{% endif %}">
        <!-- ุจุทุงูุงุช ุงูููุงููุณ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white shadow-lg rounded-lg p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-600">ุงูุฏูุฉ</p>
                        <h3 class="text-2xl font-bold">{{ "%.2f"|format(model_data.metrics.accuracy * 100) }}%</h3>
                    </div>
                    <div class="bg-green-100 p-2 rounded-lg">
                        <i class="fas fa-bullseye text-green-600"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white shadow-lg rounded-lg p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-600">F1 Score</p>
                        <h3 class="text-2xl font-bold">{{ "%.2f"|format(model_data.metrics.f1 * 100) }}%</h3>
                    </div>
                    <div class="bg-blue-100 p-2 rounded-lg">
                        <i class="fas fa-balance-scale text-blue-600"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white shadow-lg rounded-lg p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-600">ููุช ุงูุชุฏุฑูุจ</p>
                        <h3 class="text-2xl font-bold">{{ model_data.training_time }}s</h3>
                    </div>
                    <div class="bg-purple-100 p-2 rounded-lg">
                        <i class="fas fa-clock text-purple-600"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white shadow-lg rounded-lg p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-600">ุญุฌู ุงููููุฐุฌ</p>
                        <h3 class="text-2xl font-bold">{{ model_data.model_size }}</h3>
                    </div>
                    <div class="bg-yellow-100 p-2 rounded-lg">
                        <i class="fas fa-database text-yellow-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุงููุฎุทุทุงุช -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- ููุญูู ุงูุชุนูู -->
            <div class="bg-white shadow-lg rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">ููุญูู ุงูุชุนูู</h3>
                <div id="learningCurvePlot" class="h-80"></div>
            </div>

            <!-- ูุตูููุฉ ุงูุงุฑุชุจุงู -->
            <div class="bg-white shadow-lg rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">ูุตูููุฉ ุงูุงุฑุชุจุงู</h3>
                <div id="confusionMatrixPlot" class="h-80"></div>
            </div>
        </div>

        <!-- ุฃูููุฉ ุงููููุฒุงุช -->
        <div class="bg-white shadow-lg rounded-lg p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4">ุฃูููุฉ ุงููููุฒุงุช</h3>
            <div id="featureImportancePlot" class="h-96"></div>
        </div>

        <!-- ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช -->
        <div class="flex justify-end space-x-4">
            <button onclick="viewDashboard()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                <i class="fas fa-chart-line mr-2"></i>ุนุฑุถ ููุญุฉ ุงูุชุญูู
            </button>
            <button onclick="downloadReport()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                <i class="fas fa-download mr-2"></i>ุชุญููู ุงูุชูุฑูุฑ
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let modelId = '{{ model_id }}';
let websocket = null;

document.addEventListener('DOMContentLoaded', () => {
    initializeResults();
});

async function initializeResults() {
    if ('{{ model_data.status }}' !== 'completed') {
        setupWebSocket();
    } else {
        createPlots();
    }
}

function setupWebSocket() {
    websocket = new WebSocket(`ws://${window.location.host}/ws/processing/${modelId}`);
    
    websocket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        updateProgress(data);
    };
    
    websocket.onerror = (error) => {
        console.error('WebSocket error:', error);
        showError('ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู');
    };
}

function updateProgress(data) {
    const { status, progress, message, step } = data;
    
    // ุชุญุฏูุซ ุดุฑูุท ุงูุชูุฏู
    document.getElementById('progressBar').style.width = `${progress}%`;
    document.getElementById('progressPercentage').textContent = `${progress}%`;
    
    // ุชุญุฏูุซ ุงูุฎุทูุงุช
    updateSteps(step);
    
    // ุฅุฐุง ุงูุชููุช ุงููุนุงูุฌุฉ
    if (status === 'completed') {
        handleTrainingComplete();
    } else if (status === 'failed') {
        handleTrainingError(message);
    }
}

function updateSteps(currentStep) {
    const steps = ['data-loading', 'preprocessing', 'feature-engineering', 'model-selection', 'training'];
    const currentIndex = steps.indexOf(currentStep);
    
    steps.forEach((step, index) => {
        const indicator = document.querySelector(`[data-step="${step}"] .step-indicator`);
        if (index < currentIndex) {
            indicator.textContent = 'โ'; // ููุชูู
        } else if (index === currentIndex) {
            indicator.textContent = '๐'; // ุฌุงุฑู
        } else {
            indicator.textContent = 'โช'; // ูุงุฏู
        }
    });
}

function createPlots() {
    // ููุญูู ุงูุชุนูู
    const learningCurveData = {
        x: {{ model_data.learning_curve.train_sizes | tojson }},
        y: {{ model_data.learning_curve.train_scores | tojson }},
        name: 'Training Score',
        type: 'scatter',
        mode: 'lines+markers'
    };
    
    Plotly.newPlot('learningCurvePlot', [learningCurveData], {
        title: 'Learning Curve',
        xaxis: { title: 'Training Examples' },
        yaxis: { title: 'Score' }
    });

    // ูุตูููุฉ ุงูุงุฑุชุจุงู
    const confusionMatrix = {{ model_data.confusion_matrix | tojson }};
    const confusionMatrixData = [{
        z: confusionMatrix,
        type: 'heatmap',
        colorscale: 'Viridis'
    }];
    
    Plotly.newPlot('confusionMatrixPlot', confusionMatrixData, {
        title: 'Confusion Matrix'
    });

    // ุฃูููุฉ ุงููููุฒุงุช
    const featureImportance = {{ model_data.feature_importance | tojson }};
    const featureImportanceData = [{
        y: Object.keys(featureImportance),
        x: Object.values(featureImportance),
        type: 'bar',
        orientation: 'h'
    }];
    
    Plotly.newPlot('featureImportancePlot', featureImportanceData, {
        title: 'Feature Importance',
        xaxis: { title: 'Importance' },
        yaxis: { title: 'Features' }
    });
}

function handleTrainingComplete() {
    document.getElementById('progressSection').classList.add('hidden');
    document.getElementById('resultsSection').classList.remove('hidden');
    createPlots();
}

function handleTrainingError(message) {
    showError(message);
}

window.viewDashboard = () => {
    window.location.href = `/dashboard/${modelId}`;
};

window.downloadReport = () => {
    window.location.href = `/api/v1/models/${modelId}/report/download`;
};
</script>
{% endblock %}
